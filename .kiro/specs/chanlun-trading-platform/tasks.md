# Tasks

## Phase 1: 数据基础模块（MVP）

### 项目初始化

- [x] 1. 后端项目初始化
  - [x] 1.1 创建 Spring Boot 3 项目结构
  - [x] 1.2 配置 MyBatis-Plus
  - [x] 1.3 配置 PostgreSQL 数据源
  - [x] 1.4 配置统一响应格式和异常处理
  - [x] 1.5 配置 Flyway 数据库迁移
  - [x] 1.6 配置后端测试框架与基础用例 (JUnit 5 + Mockito)

- [x] 2. 前端项目初始化
  - [x] 2.1 创建 Vue 3 + TypeScript 项目
  - [x] 2.2 配置 Tailwind CSS
  - [x] 2.3 配置路由和状态管理 (Pinia)
  - [x] 2.4 配置 Axios 请求封装
  - [x] 2.5 创建基础布局组件
  - [x] 2.6 配置前端测试框架与脚本 (单测 + E2E/Playwright)

- [x] 3. 数据库初始化
  - [x] 3.1 创建 data_source 表
  - [x] 3.2 创建 market 表
  - [x] 3.3 创建 symbol 表
  - [x] 3.4 创建 kline 表
  - [x] 3.5 创建 data_gap 表
  - [x] 3.6 创建 sync_task 表
  - [x] 3.7 创建 sync_status 表
  - [x] 3.8 创建 system_config 表并插入预置配置

### 数据源管理 (需求 1.1-1.10)

- [x] 4. 后端 - 数据源 CRUD
  - [x] 4.1 实现 DataSource 实体和 Mapper
  - [x] 4.2 实现 AES-256 加密工具类
  - [x] 4.3 实现 DataSourceService (CRUD + 加密存储)
  - [x] 4.4 实现 DataSourceController (REST API)
  - [x] 4.5 实现软删除和级联禁用逻辑

- [x] 5. 后端 - 代理配置
  - [x] 5.1 实现代理配置存储
  - [x] 5.2 实现 OkHttp 代理客户端工厂
  - [x] 5.3 实现代理连接测试接口

- [x] 6. 后端 - 币安客户端
  - [x] 6.1 实现 BinanceClient 基础类 (支持代理)
  - [x] 6.2 实现连接测试方法 (ping + serverTime)
  - [x] 6.3 实现 API 限流处理
  - [x] 6.4 实现交易所 API Mock 适配 (EXCHANGE_API_MOCK 开关)

- [x] 7. 前端 - 数据源管理页面
  - [x] 7.1 数据源列表页面
  - [x] 7.2 数据源新增/编辑表单 (含代理配置)
  - [x] 7.3 连接测试功能
  - [x] 7.4 代理测试功能
  - [x] 7.5 启用/禁用开关 (带二次确认弹窗)
  - [x] 7.6 删除确认弹窗 (二次确认)
  - [x] 7.7 API 对接与联调

### 市场管理 (需求 2.1-2.4)

- [x] 8. 后端 - 市场管理
  - [x] 8.1 实现 Market 实体和 Mapper
  - [x] 8.2 实现 MarketService
  - [x] 8.3 实现 MarketController
  - [x] 8.4 实现从币安同步市场信息
  - [x] 8.5 实现市场启用/禁用 (级联禁用交易对同步)

- [x] 9. 前端 - 市场管理页面
  - [x] 9.1 市场列表页面 (按数据源分组)
  - [x] 9.2 同步市场按钮
  - [x] 9.3 启用/禁用开关 (带二次确认弹窗)
  - [x] 9.4 API 对接与联调

### 交易对管理 (需求 3.1-3.9)

- [x] 10. 后端 - 交易对管理
  - [x] 10.1 实现 Symbol 实体和 Mapper
  - [x] 10.2 实现 SymbolService
  - [x] 10.3 实现 SymbolController
  - [x] 10.4 实现从币安同步交易对列表 (exchangeInfo)
  - [x] 10.5 实现实时/历史同步开关 (默认关闭)
  - [x] 10.6 实现同步周期配置
  - [x] 10.7 实现周期合法性校验 (拒绝 1s，最小周期为 1m)

- [x] 11. 前端 - 交易对管理页面
  - [x] 11.1 交易对列表页面 (支持筛选和搜索)
  - [x] 11.2 同步交易对按钮
  - [x] 11.3 实时同步开关 (带二次确认弹窗)
  - [x] 11.4 历史同步开关 (带二次确认弹窗)
  - [x] 11.5 同步周期配置弹窗 (不显示 1s 选项)
  - [x] 11.6 API 对接与联调


### 数据同步管理 (需求 4.1-4.17)

- [x] 12. 后端 - K线数据存储
  - [x] 12.1 实现 Kline 实体和 Mapper
  - [x] 12.2 实现 KlineService (批量插入/更新)
  - [x] 12.3 实现 K线查询接口 (带分页和时间范围)
  - [x] 12.4 实现手动删除历史数据接口 (物理删除)
  - [x] 12.5 删除历史数据时同步删除相关缺口记录
  - [x] 12.6 删除历史数据后重新计算 sync_status.last_kline_time
  - [x] 12.7 删除历史数据后重新计算 sync_status.total_klines
  - [x] 12.8 删除历史数据后自动关闭 auto_gap_fill_enabled

- [x] 13. 后端 - 同步任务管理
  - [x] 13.1 实现 SyncTask 实体和 Mapper
  - [x] 13.2 实现 SyncStatus 实体和 Mapper
  - [x] 13.3 实现 SyncService (任务创建/状态更新)
  - [x] 13.4 实现 SyncController
  - [x] 13.5 实现周期级别自动回补开关 API

- [x] 14. 后端 - 历史数据同步
  - [x] 14.1 实现币安 K线 REST API 调用
  - [x] 14.2 实现历史数据批量拉取 (分段处理，单次≤30天)
  - [x] 14.3 实现手动触发历史同步接口
  - [x] 14.4 实现定时增量同步 (检查 sync.history.auto 开关)
  - [x] 14.5 实现首次启用仅补前一日数据逻辑
  - [x] 14.6 历史同步成功后更新 sync_status

- [x] 15. 后端 - 实时数据同步
  - [x] 15.1 实现币安 WebSocket K线订阅
  - [x] 15.2 实现 WebSocket 断线重连
  - [x] 15.3 实现 WebSocket 管理器 (动态订阅/取消)
  - [x] 15.4 实现断线期间数据补充 (REST API)
  - [x] 15.5 实现 sync.realtime.enabled 关闭时断开订阅
  - [x] 15.6 实时同步写入后更新 sync_status

- [x] 16. 后端 - 定时任务
  - [x] 16.1 实现 SystemConfig 读取服务
  - [x] 16.2 实现交易对列表定时同步
  - [x] 16.3 实现历史数据定时增量同步
  - [x] 16.4 实现定时任务动态配置刷新
  - [x] 16.5 配置 SchedulerConfig 时区为 UTC
  - [x] 16.6 实现同步对象筛选逻辑
  - [x] 16.7 实现 sync.realtime.enabled 全局开关检查

- [x] 17. 前端 - 数据同步页面
  - [x] 17.1 同步任务列表页面
  - [x] 17.2 同步状态查看
  - [x] 17.3 手动触发历史同步 (选择 interval + 时间范围)
  - [x] 17.4 K线数据查看/图表展示
  - [x] 17.5 手动删除历史数据入口 (带二次确认)
  - [x] 17.6 API 对接与联调

### 数据缺口检测与回补 (需求 5.1-5.11)

- [x] 18. 后端 - 缺口检测
  - [x] 18.1 实现 DataGap 实体和 Mapper
  - [x] 18.2 实现缺口检测算法 (基于时间连续性)
  - [x] 18.3 实现单交易对缺口检测接口
  - [x] 18.4 实现批量缺口检测接口
  - [x] 18.5 实现定时缺口检测
  - [x] 18.6 缺口检测仅处理符合条件的交易对

- [x] 19. 后端 - 缺口回补
  - [x] 19.1 实现单个缺口回补
  - [x] 19.2 实现批量缺口回补 (带限流)
  - [x] 19.3 实现自动缺口回补 (检查全局和周期级开关)
  - [x] 19.4 实现回补状态流转
  - [x] 19.5 实现回补重试机制
  - [x] 19.6 缺口回补创建 sync_task 记录
  - [x] 19.7 缺口回补成功后更新 sync_status

- [x] 20. 前端 - 缺口管理页面
  - [x] 20.1 缺口列表页面 (支持筛选)
  - [x] 20.2 手动检测缺口按钮
  - [x] 20.3 单个/批量回补按钮
  - [x] 20.4 缺口状态展示
  - [x] 20.5 自动回补开关配置入口
  - [x] 20.6 API 对接与联调

### 系统配置管理

- [x] 21. 后端 - 配置管理
  - [x] 21.1 实现 SystemConfig 实体和 Mapper
  - [x] 21.2 实现 ConfigService
  - [x] 21.3 实现 ConfigController

- [x] 22. 前端 - 配置管理页面
  - [x] 22.1 配置列表页面
  - [x] 22.2 配置编辑功能
  - [x] 22.3 API 对接与联调


## 验收测试

- [x] 23. 数据源管理验收
  - [x] 23.1 验证数据源 CRUD 功能
  - [x] 23.2 验证代理配置和测试
  - [x] 23.3 验证 API 密钥加密存储
  - [x] 23.4 验证软删除和级联禁用

- [x] 24. 市场和交易对管理验收
  - [x] 24.1 验证市场同步功能
  - [x] 24.2 验证交易对同步功能
  - [x] 24.3 验证同步开关默认关闭

- [x] 25. 数据同步验收
  - [x] 25.1 验证历史数据同步
  - [x] 25.2 验证实时数据同步 (WebSocket)
  - [x] 25.3 验证定时任务执行 (UTC 时区)
  - [x] 25.4 验证 K线数据查询性能 (<500ms)
  - [x] 25.5 验证同步对象筛选
  - [x] 25.6 验证 sync.realtime.enabled 全局开关
  - [x] 25.7 验证周期合法性校验 (拒绝 1s)
  - [x] 25.8 验证手动删除历史数据功能
  - [x] 25.9 验证删除后关闭自动回补开关
  - [x] 25.10 验证手动历史同步筛选规则
  - [x] 25.11 验证 last_kline_time 正确重算
  - [x] 25.12 验证 last_kline_time 为 NULL 时的处理
  - [x] 25.13 验证 total_klines 正确重算
  - [x] 25.14 验证手动历史同步时间范围校验
  - [x] 25.15 验证关闭实时同步时断开 WebSocket
  - [x] 25.16 验证历史同步更新 sync_status
  - [x] 25.17 验证实时同步更新 sync_status

- [x] 26. 缺口检测与回补验收
  - [x] 26.1 验证缺口检测准确性
  - [x] 26.2 验证缺口回补功能
  - [x] 26.3 验证自动回补限流策略
  - [x] 26.4 验证缺口检测筛选条件
  - [x] 26.5 验证周期级自动回补开关
  - [x] 26.6 验证全局+周期级开关联动
  - [x] 26.7 验证删除后自动回补关闭
  - [x] 26.8 验证缺口回补写入 sync_task
  - [x] 26.9 验证缺口回补更新 sync_status

- [x] 27. 二次确认弹窗验收
  - [x] 27.1 验证数据源删除/启用/禁用二次确认
  - [x] 27.2 验证市场启用/禁用二次确认
  - [x] 27.3 验证交易对同步开关二次确认
  - [x] 27.4 验证删除历史数据二次确认

- [x] 28. 自动化测试验收
  - [x] 28.1 验证后端单测通过 (mvn -q test)
  - [x] 28.2 验证前端 lint/typecheck/test/test:e2e 通过
  - [x] 28.3 验证关键流程 E2E 冒烟通过
  - [x] 28.4 验证 E2E Mock 开关仅覆盖外部 API

## 自动化测试

- [x] 29. 后端 - 单测与集成测试
  - [x] 29.1 覆盖历史同步增量策略与时间校验
  - [x] 29.2 覆盖缺口检测与回补流程
  - [x] 29.3 覆盖加密存储与代理配置

- [x] 30. 前端 - 组件测试
  - [x] 30.1 覆盖数据同步页面时间范围输入与校验
  - [x] 30.2 覆盖自动回补开关配置入口

- [x] 31. E2E 冒烟 (Playwright/Chromium)
  - [x] 31.1 E2E 环境准备 (EXCHANGE_API_MOCK=true)
  - [x] 31.2 数据源新增 + 连接测试
  - [x] 31.3 手动历史同步 (指定时间范围)
  - [x] 31.4 缺口检测 + 回补流程
